<html
  xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
  xmlns:c="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
  xmlns:fl="http://typo3.org/ns/Pagemachine/Formlog/ViewHelpers"
  data-namespace-typo3-fluid="true">

<f:be.pageRenderer
  includeCssFiles="{
    1: '{f:uri.resource(path: \'Css/knockout-daterangepicker/daterangepicker.css\')}',
    99: '{f:uri.resource(path: \'Css/formlog.css\')}'
  }"
  includeRequireJsModules="{
    0: 'TYPO3/CMS/Formlog/FormLog/Filter'
  }"
  addInlineSettings="{inlineSettings}"
/>

<h1><f:translate key="formlog.title"/> <span class="label label-{f:if(condition: filters.empty, then: 'default', else: 'primary')}">{entries -> f:count()}</span></h1>

<f:if condition="{entries -> f:count()} > 0">
  <f:then>

    <fl:iterator.paginate iterable="{entries}" as="paginatedEntries" currentPage="{pagination.currentPage}">

      <f:form objectName="filters" object="{filters}" id="filter-form" class="form-inline">
        <f:form.hidden id="submissiondate-start" property="submissionDate.startDate" value="{filters.submissionDate.startDate -> f:format.date(format: isoDateFormat)}"/>
        <f:form.hidden id="submissiondate-end" property="submissionDate.endDate" value="{filters.submissionDate.endDate -> f:format.date(format: isoDateFormat)}"/>

        <div class="panel panel-default">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th></th>
                <th><f:translate key="formlog.entry.uid"/></th>
                <th>
                  <button
                    type="button"
                    id="pagetitle-filter"
                    class="btn btn-{f:if(condition: filters.pageTitle.empty, then: 'default', else: 'primary')}"
                  >
                    <b><f:translate key="formlog.entry.page.title"/></b>
                    <i class="fa fa-filter" aria-hidden="true"></i>
                  </button>
                  <div class="hidden">
                    <f:form.select id="pagetitle" class="form-control" property="pageTitle.value" prependOptionLabel="" data="{value: filters.pageTitle.value}"/>
                  </div>
                </th>
                <th><f:translate key="formlog.entry.identifier"/></th>
                <th><f:translate key="formlog.entry.language"/></th>
                <th>
                  <button
                    type="button"
                    id="submissiondate-filter"
                    class="btn btn-{f:if(condition: filters.submissionDate.empty, then: 'default', else: 'primary')}"
                    data-start-date-field="#submissiondate-start"
                    data-end-date-field="#submissiondate-end"
                    data-translations="{daterangepickerTranslations -> f:format.json()}"
                  >
                    <b><f:translate key="formlog.entry.submissionDate"/></b>
                    <i class="fa fa-filter" aria-hidden="true"></i>
                  </button>
                </th>

                <f:for each="{settings.list.columns}" as="column">
                  <th><f:translate key="{column.label}">{column.label}</f:translate></th>
                </f:for>
              </tr>
            </thead>

            <f:alias map="{
              defaultLanguageLabel: '{f:translate(key: \'formlog.entry.language.default\')}'
            }">
            <f:for each="{paginatedEntries}" as="entry">

              <tr>
                <td><a href="{fl:uri.editRecord(uid: entry.uid, tableName: 'tx_formlog_entries')}" class="btn btn-default btn-sm"><core:icon identifier="actions-document-view"/></a></td>
                <td>{entry.uid}</td>
                <td title="{entry.page.uid}">
                  {entry.page.title}
                  <f:link.action
                    arguments="{
                      filters: {
                        pageTitle: {
                          value: entry.page.title
                        }
                      }
                    }"
                    class="btn btn-default filter-button"
                    title="{f:translate(key: 'formlog.filters.this')}"
                    addQueryString="true"
                    addQueryStringMethod="POST,GET">
                    <i class="fa fa-filter" aria-hidden="true"></i>
                  </f:link.action>
                </td>
                <td>{entry.identifier}</td>
                <td>{entry.language.title -> f:or(alternative: defaultLanguageLabel)}</td>
                <td>
                  {entry.submissionDate -> f:format.date(format: dateFormat)}
                  <f:link.action
                    arguments="{
                      filters: {
                        submissionDate: {
                          startDate: '{entry.submissionDate -> f:format.date(format: \'Y-m-d\T00:00:00P\')}',
                          endDate: '{entry.submissionDate -> f:format.date(format: \'Y-m-d\T23:59:59P\')}'
                        }
                      }
                    }"
                    class="btn btn-default filter-button"
                    title="{f:translate(key: 'formlog.filters.this')}"
                    addQueryString="true"
                    addQueryStringMethod="POST,GET">
                    <i class="fa fa-filter" aria-hidden="true"></i>
                  </f:link.action>
                </td>

                <f:for each="{settings.list.columns}" as="column">
                  <td><f:render section="columnValue" contentAs="value">{entry.{column.property}}</f:render></td>
                </f:for>
              </tr>

            </f:for>
            </f:alias>

          </table>

          <div class="panel-footer">
            <div class="row">
              <div class="col-sm-8">
                <f:render partial="Pagination" arguments="{pagination: pagination}"/>
              </div>
              <div class="col-sm-4 text-right">
                <f:if condition="!{filters.empty}">
                  <div class="btn-group">
                    <a href="#filters-info" class="btn btn-primary" data-toggle="collapse"><i class="fa fa-filter" aria-hidden="true"></i> <f:translate key="formlog.filters.title"/> <span class="badge">{filters -> f:count()}</span></a>
                    <f:link.action class="btn btn-default"><i class="fa fa-undo" aria-hidden="true"></i> <f:translate key="formlog.filters.clear"/></f:link.action>
                  </div>
                </f:if>

                <f:if condition="{settings.export.columns}">
                  <f:then>

                    <div class="btn-group dropup" role="group">
                      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <c:icon identifier="actions-database-export"/>
                        <f:translate key="formlog.export"/>
                        <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-right">
                        <li>
                          <f:link.action
                            action="export"
                            format="csv"
                            addQueryString="true"
                            addQueryStringMethod="POST,GET">
                            <c:icon identifier="mimetypes-text-csv"/>
                            <f:translate key="formlog.export.csv"/>
                          </f:link.action>
                        </li>
                        <li>
                          <f:link.action
                            action="export"
                            format="xlsx"
                            addQueryString="true"
                            addQueryStringMethod="POST,GET">
                            <c:icon identifier="mimetypes-excel"/>
                            <f:translate key="formlog.export.xlsx"/>
                          </f:link.action>
                        </li>
                      </ul>
                    </div>

                  </f:then>
                  <f:else>
                    <button type="button" class="btn btn-default" disabled title="{f:translate(key: 'formlog.export.unconfigured')}">
                      <c:icon identifier="actions-document-export-csv"/>
                      <f:translate key="formlog.export.csv"/>
                    </button>
                  </f:else>
                </f:if>
              </div>
            </div>

            <f:if condition="!{filters.empty}">
              <div id="filters-info" class="collapse">
                <div class="well well-sm">
                  <p><f:translate key="formlog.filters.explanation"/></p>

                  <dl>
                    <f:for each="{filters}" as="filter" key="name">

                      <dt><f:translate key="formlog.entry.{name}"/></dt>
                      <dd>
                        <f:if condition="{filter.startDate} && {filter.endDate}">
                          <f:then>{filter.startDate -> f:format.date(format: dateFormat)} â€¦ {filter.endDate -> f:format.date(format: dateFormat)}</f:then>
                          <f:else if="{filter.value}">{filter.value}</f:else>
                        </f:if>
                      </dd>

                    </f:for>
                  </dl>
                </div>
              </div>
            </f:if>

          </div>
        </div>

      </f:form>

    </fl:iterator.paginate>

  </f:then>
  <f:else>

    <div class="alert alert-info"><f:translate key="formlog.empty"/></div>

  </f:else>
</f:if>

<f:section name="columnValue">

  <f:if condition="{value.0}">
    <f:then>
      <f:for each="{value}" as="singleValue" iteration="i">
        {singleValue}<f:if condition="!{i.isLast}">,</f:if>
      </f:for>
    </f:then>
    <f:else>{value}</f:else>
  </f:if>

</f:section>
